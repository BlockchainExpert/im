<!DOCTYPE html>

<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Loqui IM Source: src/scripts/loqui/messenger.js</title>

	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/sunlight.default.css">

	<link type="text/css" rel="stylesheet" href="styles/site.loqui.css">

</head>

<body>

<div class="navbar navbar-default navbar-fixed-top navbar-inverse">
<div class="container">
	<div class="navbar-header">
		<a class="navbar-brand" href="index.html">
			
				<img class="branding-logo" src="img/logo.png" alt="logo">
			
			Loqui IM
		</a>
	</div>
	<div class="navbar-collapse">
		<ul class="nav navbar-nav">
			
			<li class="dropdown">
				<a href="namespaces.list.html" class="dropdown-toggle" data-toggle="dropdown">Namespaces<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="App.html">App</a></li><li><a href="Geo.html">Geo</a></li><li><a href="Menu.html">Menu</a></li><li><a href="Menu.map.html">Menu.map</a></li><li><a href="Plus.html">Plus</a></li>
				</ul>
			</li>
			
			<li class="dropdown">
				<a href="classes.list.html" class="dropdown-toggle" data-toggle="dropdown">Classes<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="Chat.html">Chat</a></li><li><a href="ChatCore.html">ChatCore</a></li><li><a href="Connector_CoSeMe.html">Connector/CoSeMe</a></li><li><a href="external-System.MozActivity.html">external:System.MozActivity</a></li><li><a href="external-System.Notification.html">external:System.Notification</a></li><li><a href="external-System.Promise.html">external:System.Promise</a></li><li><a href="external-System.WakeLock.html">external:System.WakeLock</a></li><li><a href="Geo.Pos.html">Geo.Pos</a></li><li><a href="Number.html">Number</a></li><li><a href="Object.html">Object</a></li>
				</ul>
			</li>
			
			<li class="dropdown">
				<a href="interfaces.list.html" class="dropdown-toggle" data-toggle="dropdown">Interfaces<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="Connector.html">Connector</a></li>
				</ul>
			</li>
			
			<li class="dropdown">
				<a href="global.html" class="dropdown-toggle" data-toggle="dropdown">Global<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="global.html#Activity">Activity</a></li>
				</ul>
			</li>
			
			<li class="dropdown">
				<a href="externals.list.html" class="dropdown-toggle" data-toggle="dropdown">Externals<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="external-System.html">System</a></li>
				</ul>
			</li>
			
		</ul>
	</div>
</div>
</div>


<div class="container">
<div class="row">

	
	<div class="col-md-12">
	
		<div id="main">
			

		<h1 class="page-title">Source: src/scripts/loqui/messenger.js</h1>
    
<section>
	<article>
		<pre
			class="sunlight-highlight-javascript linenums">/* global Accounts, App, Message, Tools, Lungo, Providers, Menu, Store, Make */

/**
* @file Holds {@link Connector/XMPP}
* @author [Adán Sánchez de Pedro Crespo]{@link https://github.com/aesedepece}
* @author [Jovan Gerodetti]{@link https://github.com/TitanNano}
* @author [Christof Meerwald]{@link https://github.com/cmeerw}
* @author [Giovanny Andres Gongora Granada]{@link https://github.com/Gioyik}
* @author [Sukant Garg]{@link https://github.com/gargsms}
* @license AGPLv3
*/

'use strict';

var Messenger = {

  account: function () {
    var index = Accounts.find($('section#main')[0].dataset.jid);
    return App.accounts[index];
  },

  add: function (emoji) {
    var textBox = $('article#main div#footbox div#text');
    textBox.append(emoji);
    textBox[0].dispatchEvent(new Event('keydown'));
  },

  say: function (text) {
    var to = $('section#chat')[0].dataset.jid;
    var muc = $('section#chat')[0].dataset.muc == "true";
    var account = Accounts.current;
    text = text || $('section#chat div#text').text();
    text = text.trim();
    if (text.length) {
      var msg = Make(Message)(account,
      {
        from: account.core.user,
        to: to,
        text: text,
        stamp: Tools.localize(Tools.stamp()),
        status : ''
      },
      {
        muc: muc
      });
      msg.send();
      Lungo.Router.article('chat', 'main');
      var ul = $('section#chat ul#messages');
      ul[0].scrollTop = ul[0].scrollHeight;
      $('#chat #messages span.lastRead').remove();
      App.audio('sent');
    }
    $('section#chat div#text').empty();
    $('section#chat article#main button#plus').show();
    $('section#chat article#main button#say').hide();
  },

  csn: function (state) {
    var to = $('section#chat')[0].dataset.jid;
    var account = Accounts.current;
    var muc = account.chatGet(to).core.muc;
    if (account.connector.isConnected() &amp;&amp; account.supports('csn') &amp;&amp; App.settings.csn &amp;&amp; !muc) {
      if(this.typingTimeout){
        clearTimeout(this.typingTimeout);
        this.typingTimeout= null;
      }
      if(state == 'composing'){
        if(!this.composingInterval){
          this.composingInterval= setInterval(function(){
            account.connector.csnSend(to, 'composing');
          }, 15000);
          account.connector.csnSend(to, state);
        }
        this.typingTimeout= setTimeout(function(){
          account.connector.csnSend(to, 'paused');
          clearInterval(this.composingInterval);
          this.composingInterval= null;
        }.bind(this), 5000);
      }else{
        account.connector.csnSend(to, state);
        clearInterval(this.composingInterval);
        this.composingInterval= null;
      }
    }
  },

  avatarSet: function (blob) {
    var account = Accounts.current;
    if (account.supports('avatarChange')) {
      account.connector.avatarSet(blob);
    } else {
      Lungo.Notification.error(_('NoSupport'), _('XMPPisBetter'), 'exclamation-sign', 3);
    }
  },

  presenceUpdate: function () {
    var account = Accounts.current;
    if (App.online &amp;&amp; account.connector.connected) {
      var status = $('section#me #status input').val();
      var nick = $('section#me #nick input').val();
      account.connector.presence.set(null, status, nick);
    } else {
      Lungo.Notification.error(_('Error'), _('NoWhenOffline'), 'exclamation-sign', 3);
    }
  },

  contactProfile: function (jid) {
	jid = jid || $('section#chat')[0].dataset.jid;

    var account = Accounts.current;
    var contact = Lungo.Core.findByProperty(account.core.roster, 'jid', jid);
    var chat = account.chatGet(jid);
    var name = contact ? contact.name : jid;
    var status = contact ? contact.presence.status : _('showna');
    var section = $('section#contact');
    var setUl = section.find('#settings ul').empty();

    section[0].dataset.jid= jid;
    section.find('#card .name').text(name == jid ? jid.split('@')[0] : name);
    section.find('#card .user').text(jid);
    section.find('#card .provider').empty().append($('&lt;img/>').attr('src', 'img/providers/squares/' + account.core.provider + '.svg'));
    section.find('#status p').html(App.emoji[Providers.data[account.core.provider].emoji].fy(status));

    var accountSwitch = function (e) {
      var sw = $(this);
      var li = sw.closest('li');
      var key = li[0].dataset.key;
      var chat = account.chatGet(jid);

      if (li[0].dataset.value == 'true') {
        chat.core.settings[key][0] = false;
      } else {
        chat.core.settings[key][0] = true;
      }

      li[0].dataset.value= chat.core.settings[key][0];

      account.save();
      account.singleRender(chat, false);
    };

    if (contact) {
      $('section#contact button[data-menu-onclick="contactRemove"]').removeClass('hidden');
      $('section#contact button[data-menu-onclick="contactAdd"]').addClass('hidden');
    } else {
      $('section#contact button[data-menu-onclick="contactAdd"]').removeClass('hidden');
      $('section#contact button[data-menu-onclick="contactRemove"]').addClass('hidden');
    }

    Object.keys(chat.core.settings).forEach(function(key){
      var value= chat.core.settings[key];
      var li = $('&lt;li/>');
      li[0].dataset.key= key;
      li[0].dataset.value= (value.length > 1 ? value[0] : value);
      li.bind('click', accountSwitch);
      li.append(
        $('&lt;span/>').addClass('caption').text(_('AccountSet' + key))
      ).append(
        $('&lt;div class="switch">&lt;div class="ball">&lt;/div>&lt;img src="img/tick.svg" class="tick" />&lt;/div>')
      );

      if (value.length > 1 &amp;&amp; value[1]) {
        li.on('click', function (e) {
          Tools.log(value, value[1]);
          Menu.show(value[1], li[0]);
        });
      }
      setUl.append(li);
    });

    if (App.avatars[jid]) {
      Store.recover(App.avatars[jid].chunk, function (key, val, free) {
        section.find('#card .avatar').children('img').attr('src', val);

        free();
      });
    } else {
      section.find('#card .avatar').children('img').attr('src', 'img/foovatar.png');
    }
    Lungo.Router.section('contact');
  },

  mucProfile: function (jid) {
    var account = Accounts.current;
    jid = jid || $('section#chat')[0].dataset.jid;
    var ci = account.chatFind(jid);
    var section = $('section#muc');
    if (ci >= 0) {
      var chat = account.chats[ci];
      section[0].dataset.jid= jid;
      section[0].dataset.mine= (chat.core.info &amp;&amp; chat.core.info.owner == account.core.fullJid);
      section.find('#card .name').html(App.emoji[Providers.data[account.core.provider].emoji].fy(chat.core.title));
      section.find('#card .provider').empty().append($('&lt;img/>').attr('src', 'img/providers/squares/' + account.core.provider + '.svg'));
      section.find('#participants h2').text(_('NumParticipants', {number: chat.core.participants.length}));
      var partUl = section.find('#participants ul').empty();
      for (var i in chat.core.participants) {
        var participantJid = chat.core.participants[i];
        var contact = Lungo.Core.findByProperty(account.core.roster, 'jid', participantJid);
        var label = "";

        if(contact) {
          label = contact.name;
        } else if (participantJid == account.core.fullJid) {
          label = _('Me');
        } else {
          label = participantJid.split('@')[0];
        }

        partUl.append($('&lt;li/>').text(label));
      }
      var setUl = section.find('#settings ul').empty();
      var accountSwitch = function (e) {
        var sw = $(this);
        var li = sw.closest('li');
        var key = li[0].dataset.key;
        var chat = account.chatGet(jid);

        if (li[0].dataset.value == 'true') {
          chat.core.settings[key][0] = false;
        } else {
          chat.core.settings[key][0] = true;
        }
        li[0].dataset.value= chat.core.settings[key][0];
        account.save();
        account.singleRender(chat, false);
      };
      Object.keys(chat.core.settings).forEach(function(key){
        var value= chat.core.settings[key];
        var li = $('&lt;li/>');
        li[0].dataset.key= key;
        li.append(
          $('&lt;span/>').addClass('caption').text(_('AccountSet' + key))
        ).append(
          $('&lt;div class="switch">&lt;div class="ball">&lt;/div>&lt;img src="img/tick.svg" class="tick" />&lt;/div>')
        );
        li[0].dataset.value= (value.length > 1 ? value[0] : value);
        li.bind('click', accountSwitch);
        if (value.length > 1 &amp;&amp; value[1]) {
          li.on('click', function (e) {
            Tools.log(value, value[1]);
            Menu.show(value[1], li[0]);
          });
        }
        setUl.append(li);
      });
    }
    if (App.avatars[jid]) {
      Store.recover(App.avatars[jid].chunk, function (key, val, free) {
        section.find('#card .avatar').children('img').attr('src', val);

        free();
      });
    } else {
      section.find('#card .avatar').children('img').attr('src', 'img/goovatar.png');
    }
    Lungo.Router.section('muc');
  },

  contactAdd: function () {
    var account = Accounts.current;
    if (App.online &amp;&amp; account.connector.connection.connected) {
      if (account.supports('rosterMgmt')) {
        var section = $('section#contactAdd');
        var jid = section.find('input[name="address"]').val();
        var name = section.find('input[name="name"]').val();
        if (jid &amp;&amp; name) {
          account.connector.connection.roster.add(jid, name, false, false);
          account.connector.connection.roster.subscribe(jid);
          account.connector.connection.roster.authorize(jid);
          section.find('input').val('');
          account.core.roster.push({
            jid: jid,
            name: name,
            show: undefined,
            status: undefined
          });
          account.core.roster.sort(function (a,b) {
            var aname = a.name ? a.name : a.jid;
            var bname = b.name ? b.name : b.jid;
            return aname > bname;
          });
          account.save();
          account.allRender();
          Lungo.Router.section('main');
          Lungo.Notification.success(_('ContactWasAdded', {name: name}), _('ContactWillAppear', {name: name}), 'check', 5);
        }
      } else {
        Lungo.Notification.error(_('NoSupport'), _('XMPPisBetter'), 'exclamation-sign', 3);
      }
    } else {
      Lungo.Notification.error(_('Error'), _('NoWhenOffline'), 'exclamation-sign', 3);
    }
  },

  contactRemove: function (jid) {
    var account = Accounts.current;
    if (App.online &amp;&amp; account.connector.connected) {
      if (account.supports('rosterMgmt')) {
        var contact = Lungo.Core.findByProperty(account.core.roster, 'jid', jid);
        var name = contact.name || jid;
        var will = confirm(_('ConfirmContactRemove', {name: name}));
        if (will) {
          account.connector.contacts.remove(jid);
          var ri;
          for (var i in account.core.roster) {
            if (account.core.roster[i].jid == jid) {
              ri = i;
              break;
            }
          }
          var ci = account.chatFind(jid);
          if (ci >= 0) {
            var chat = account.chats[ci];
            for (i in chat.chunks) {
              var chunk = chat.chunks[i];
              Store.blockDrop(chunk);
            }
            account.chats.splice(ci, 1);
          }
          account.core.roster.splice(ri, 1);
          account.save();
          account.allRender();
          Lungo.Router.section('main');
          Lungo.Notification.success(_('Removed'), null, 'remove', 3);
        }
      } else {
        Lungo.Notification.error(_('NoSupport'), _('XMPPisBetter'), 'exclamation-sign', 3);
      }
    } else {
      Lungo.Notification.error(_('Error'), _('NoWhenOffline'), 'exclamation-sign', 3);
    }
  },

  chatRemove: function (jid, account, force) {
    account = account || Accounts.current;
    var index = account.chatFind(jid);
    if (index >= 0) {
      var chat = Lungo.Core.findByProperty(account.core.chats, 'jid', jid);
      var name = chat.title || jid;
      var will = force || confirm(_('ConfirmChatRemove', {name: name}));
      if (will) {
        chat = account.chats[index];
        for (var i in chat.chunks) {
          var chunk = chat.chunks[i];
          Store.blockDrop(chunk);
        }
        account.chats.splice(index, 1);
        account.core.chats.splice(index, 1);
        account.save();
        if (!force) {
          account.allRender();
          Lungo.Router.section('back');
          Lungo.Router.section('main');
          Lungo.Notification.success(_('Removed'), null, 'trash', 3);
        }
      }
    } else if (!force) {
      Lungo.Notification.error(_('Error'), _('NoChatsForContact'), 'exclamation-sign', 3);
    }
  },

  mucClear: function (gid, force) {
    var account = Accounts.current;
    var chat = account.chatGet(gid);
    var index = account.chatFind(gid);
    if (chat) {
      chat = chat.core;
      var title = chat.title || gid;
      var will = force || confirm(_('MucClearConfirm', {title: title}));
      if (will) {
        for (var i in chat.chunks) {
          var chunk = chat.chunks[i];
          Store.blockDrop(chunk);
        }
        chat.chunks = [];
        if (force) {
          account.chats.splice(index, 1);
          account.core.chats.splice(index, 1);
        }
        account.save();
        account.allRender();
        Lungo.Router.section('back');
        Lungo.Router.section('main');
        Lungo.Notification.success(_('Cleared'), null, 'trash', 3);
      }
    } else {
      Lungo.Notification.error(_('Error'), _('NoChatsForContact'), 'exclamation-sign', 3);
    }
  },

  mucExit: function (gid) {
    var account = Accounts.current;
    var chat = account.chatGet(gid).core;
    var title = chat.title || gid;
    var will = confirm(_('MucExitConfirm', {title: title}));
    if (will) {
      account.connector.muc.expel(gid);
      this.mucClear(gid, true);
    }
  },

  accountRemove: function (jid) {
    var account = Accounts.current;
    var will = confirm(_('ConfirmAccountRemove', {account: account.core.user}));
    if (will) {
      var accountIndex = Accounts.find(account.core.fullJid);
      var chat = account.chats[account.chatFind(jid)];
      if (chat) {
        for (var i in chat.chunks) {
          var chunk = chat.chunks[i];
          Store.blockDrop(chunk);
        }
      }
      App.accounts.splice(accountIndex, 1);
      App.accountsCores.splice(accountIndex, 1);
      App.accounts = App.accounts;
      Lungo.Notification.success(_('Wait'), _('WaitLong'), 'exclamation-sign', 3);
      setTimeout(function () {
        window.location.reload();
      }, 3000);
    }
  }

};
</pre>
	</article>
</section>





		</div>
	</div>

	<div class="clearfix"></div>

	

</div>
</div>


<footer>


	<span class="copyright">
	DocStrap Copyright © 2012-2014 The contributors to the JSDoc3 and DocStrap projects.
	</span>
	<br />

<span class="jsdoc-message">
	Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0-dev</a>
	on Sun Nov 1st 2015 using the <a href="https://github.com/terryweiss/docstrap">DocStrap template</a>.
</span>
<span class="jsdoc-message">
	Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0-dev</a>
	on Sun Nov 1st 2015 using the <a
	href="https://github.com/terryweiss/docstrap">DocStrap template</a>.
</span>
</footer>

<!--<script src="scripts/sunlight.js"></script>-->
<script src="scripts/docstrap.lib.js"></script>
<script src="scripts/bootstrap-dropdown.js"></script>
<script src="scripts/toc.js"></script>

<script>
$( function () {
	$( "[id*='$']" ).each( function () {
		var $this = $( this );

		$this.attr( "id", $this.attr( "id" ).replace( "$", "__" ) );
	} );

	$( "#toc" ).toc( {
		anchorName  : function ( i, heading, prefix ) {
			var id = $( heading ).attr( "id" );
			return id && id.replace(/\~/g, '-inner-').replace(/\./g, '-static-') || ( prefix + i );
		},
		selectors   : "h1,h2,h3,h4",
		showAndHide : false,
		scrollTo    : "100px"
	} );

	$( "#toc>ul" ).addClass( "nav nav-pills nav-stacked" );
	$( "#main span[id^='toc']" ).addClass( "toc-shim" );
	$( '.dropdown-toggle' ).dropdown();
	//			$( ".tutorial-section pre, .readme-section pre" ).addClass( "sunlight-highlight-javascript" ).addClass( "linenums" );

	$( ".tutorial-section pre, .readme-section pre" ).each( function () {
		var $this = $( this );

		var example = $this.find( "code" );
		exampleText = example.html();
		var lang = /{@lang (.*?)}/.exec( exampleText );
		if ( lang && lang[1] ) {
			exampleText = exampleText.replace( lang[0], "" );
			example.html( exampleText );
			lang = lang[1];
		} else {
			lang = "javascript";
		}

		if ( lang ) {

			$this
			.addClass( "sunlight-highlight-" + lang )
			.addClass( "linenums" )
			.html( example.html() );

		}
	} );

	Sunlight.highlightAll( {
		lineNumbers : true,
		showMenu : true,
		enableDoclinks : true
	} );
} );
</script>



<!--Navigation and Symbol Display-->


<!--Google Analytics-->


</body>
</html>
