<!DOCTYPE html>

<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Loqui IM Source: src/scripts/loqui/connectors/xmpp.js</title>

	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/sunlight.default.css">

	<link type="text/css" rel="stylesheet" href="styles/site.loqui.css">

</head>

<body>

<div class="navbar navbar-default navbar-fixed-top navbar-inverse">
<div class="container">
	<div class="navbar-header">
		<a class="navbar-brand" href="index.html">
			
				<img class="branding-logo" src="img/logo.png" alt="logo">
			
			Loqui IM
		</a>
	</div>
	<div class="navbar-collapse">
		<ul class="nav navbar-nav">
			
			<li class="dropdown">
				<a href="namespaces.list.html" class="dropdown-toggle" data-toggle="dropdown">Namespaces<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="Accounts.html">Accounts</a></li><li><a href="App.html">App</a></li><li><a href="Connector.contacts.html">Connector.contacts</a></li><li><a href="Connector.muc.html">Connector.muc</a></li><li><a href="Connector.presence.html">Connector.presence</a></li><li><a href="Geo.html">Geo</a></li><li><a href="Menu.html">Menu</a></li><li><a href="Menu.map.html">Menu.map</a></li><li><a href="Plus.html">Plus</a></li><li><a href="Providers.html">Providers</a></li><li><a href="Store.html">Store</a></li><li><a href="Store.SD.html">Store.SD</a></li>
				</ul>
			</li>
			
			<li class="dropdown">
				<a href="classes.list.html" class="dropdown-toggle" data-toggle="dropdown">Classes<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="Account.html">Account</a></li><li><a href="Chat.html">Chat</a></li><li><a href="ChatCore.html">ChatCore</a></li><li><a href="Connector_CoSeMe.html">Connector/CoSeMe</a></li><li><a href="external-System.MozActivity.html">external:System.MozActivity</a></li><li><a href="external-System.Notification.html">external:System.Notification</a></li><li><a href="external-System.Promise.html">external:System.Promise</a></li><li><a href="external-System.WakeLock.html">external:System.WakeLock</a></li><li><a href="Geo.Pos.html">Geo.Pos</a></li><li><a href="Message.html">Message</a></li><li><a href="Number.html">Number</a></li><li><a href="Object.html">Object</a></li>
				</ul>
			</li>
			
			<li class="dropdown">
				<a href="interfaces.list.html" class="dropdown-toggle" data-toggle="dropdown">Interfaces<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="Connector.html">Connector</a></li>
				</ul>
			</li>
			
			<li class="dropdown">
				<a href="global.html" class="dropdown-toggle" data-toggle="dropdown">Global<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="global.html#AccountCore">AccountCore</a></li><li><a href="global.html#Activity">Activity</a></li>
				</ul>
			</li>
			
			<li class="dropdown">
				<a href="externals.list.html" class="dropdown-toggle" data-toggle="dropdown">Externals<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="external-System.html">System</a></li>
				</ul>
			</li>
			
		</ul>
	</div>
</div>
</div>


<div class="container">
<div class="row">

	
	<div class="col-md-12">
	
		<div id="main">
			

		<h1 class="page-title">Source: src/scripts/loqui/connectors/xmpp.js</h1>
    
<section>
	<article>
		<pre
			class="sunlight-highlight-javascript linenums">/* global App, Providers, Tools, Lungo, $build, $pres, $msg, Avatar, Store, Chat, Message, Account, Accounts, Make */

/**
* @file Holds {@link Connector/XMPP}
* @author [Adán Sánchez de Pedro Crespo]{@link https://github.com/aesedepece}
* @author [Jovan Gerodetti]{@link https://github.com/TitanNano}
* @author [Christof Meerwald]{@link https://github.com/cmeerw}
* @author [Giovanny Andres Gongora Granada]{@link https://github.com/Gioyik}
* @author [Sukant Garg]{@link https://github.com/gargsms}
* @license AGPLv3
*/

'use strict';

App.connectors.XMPP = function (account) {

  this.account = account;
  this.provider = Providers.data[account.core.provider];
  this.presence = {
    show: this.account.core.presence ? this.account.core.presence.show : App.defaults.Connector.presence.show,
    status: this.account.core.presence ? this.account.core.presence.status : App.defaults.Connector.presence.status
  };
  this.handlers = {onDisco: [], onTime: []};
  this.events = {};
  this.chat = {};
  this.muc = {};
  this.contacts = {};
  this.connected = false;

  this.connection = new Strophe.Connection(this.provider.connector.host);
  this.connection.rawInput = function (data) {Tools.log('RECV', this.account.core.fullJid, data);}.bind(this);
  this.connection.rawOutput = function (data) {Tools.log('SENT', this.account.core.fullJid, data);}.bind(this);

  this.connect = function (callback) {
    //var user = this.account.core.user + '/' + App.shortName + '-' + Math.random().toString(36).substr(2, 5);
    var user = this.account.core.user + '/' + App.shortName;
    var pass = this.account.core.pass;
    var handler = function (status) {
     switch (status) {
        case Strophe.Status.CONNECTING:
          Tools.log('Connecting');
          if (callback.connecting) {
            callback.connecting();
          }
          break;
        case Strophe.Status.CONNFAIL:
          Tools.log('Connection failed');
          if (callback.connfail) {
            callback.connfail();
          }
          Lungo.Notification.error(_('NoAuth'), _('NoAuthNotice'), 'remove-circle', 5);
          break;
        case Strophe.Status.AUTHENTICATING:
          Tools.log('Authenticating');
          if (callback.authenticating) {
            callback.authenticating();
          }
          break;
        case Strophe.Status.AUTHFAIL:
          Tools.log('Authentication failed');
          if (callback.authfail) {
            callback.authfail();
          }
          break;
        case Strophe.Status.CONNECTED:
          Tools.log('Connected');
          this.connected = true;
          if (callback.connected) {
            callback.connected();
          }
          break;
        case Strophe.Status.DISCONNECTING:
          Tools.log('Disconnecting');
          if (callback.disconnecting) {
            callback.disconnecting();
          }
          break;
        case Strophe.Status.DISCONNECTED:
          Tools.log('Disconnected');
          this.connected = false;
          if (callback.disconnected) {
            callback.disconnected();
          }
          break;
      }
    }.bind(this);
    this.connection.reset();
    this.connection.connect(user, pass, handler, this.provider.connector.timeout);
  };

  this.disconnect = function () {
    this.connected = false;
    this.connection.disconnect();
  };

  this.isConnected = function () {
    return App.online &amp;&amp; this.connected;
  };

  this.start = function () {
    this.handlers.init();
    this.capabilize();
    this.muc.init();
  };

  this.sync = function (callback) {
    var account = this.account;
    var connector = this;
    var fullJid = Strophe.getBareJidFromJid(connector.connection.jid);
    if (account.core.fullJid != fullJid) {
      account.core.fullJid = fullJid;
      account.save();
    }
    connector.connection.roster.clearCallbacks();
    connector.connection.roster.registerCallback(connector.events.onPresence);
    connector.connection.roster.get( function (ret) {
      connector.events.onPresence(ret, null, account.core.user);
      if (account.supports('vcard')) {
        var iqId = connector.connection.vcard.get( function (data) {
          connector.vcard = $(data).find('vCard').get(0);
          callback();
        });
        // Send initial vcard if none is present (#181)
        connector.connection.addHandler(function () {
          connector.connection.vcard.set(function () {
            callback();
          }, $build('JABBERID').t(fullJid).tree());
        }, null, 'iq', 'error', iqId);
      } else {
        callback();
      }
    });
  }.bind(this);

  this.capabilize = function () {
    var caps = [
      ['attention', Strophe.NS.XEP0224],
      ['csn', Strophe.NS.XEP0085],
      ['delay', Strophe.NS.XEP0203],
      ['time', Strophe.NS.XEP0202],
      ['vcard', Strophe.NS.VCARD],
      ['receipts', Strophe.NS.XEP0184],
      ['directInvite', Strophe.NS.XEP0249]
    ];
    for (var i in caps) {
      if (this.account.supports(caps[i][0])) {
        this.connection.caps.addFeature(caps[i][1]);
      }
    }
  };

  this.presence.set = function (show, status) {
    this.presence.show = show || this.presence.show;
    this.presence.status = status || this.presence.status;
    this.presence.send();
    this.account.core.presence = {
      show: this.presence.show,
      status: this.presence.status
    };
    this.account.save();
  }.bind(this);

  this.presence.send = function (show, status) {
    show = show || this.presence.show;
    status = status || this.presence.status;
    var idle = document.hidden ? new Date() - App.lastActive : 0;
    var priority =
      idle &lt; 1000 ? 100 :
      idle &lt; 5000 ? 80 :
      idle &lt; 30000 ? 60 :
      40;
    priority += {
      chat: -4,
      a: -4,
      dnd: -4,
      away: -8,
      xa: -12
    }[show];
    if (App.online &amp;&amp; this.connection.connected) {
      var msg = $pres();
      if (show != 'a') {
        msg.c('show', {}, show);
      }
      if (status) {
        msg.c('status', {}, status);
      }
      msg.c('priority', {}, String(priority));
      msg.cnode(this.connection.caps.createCapsNode().tree()).up();
      if (this.account.core.avatarHash) {
        var photoNode = this.account.core.avatarHash ? $build('photo').t(this.account.core.avatarHash) : $build('photo');
        msg.cnode(this.connection.vcard.createUpdateNode(photoNode.tree()).tree()).up();
      }
      this.connection.send(msg.tree());
    }
    $('section#main').attr('data-show', show);
  }.bind(this);

  this.send = function (to, text, options) {
    var stanza = null;
    if (options.muc) {
      stanza = this.connection.muc.message(to, Strophe.getNodeFromJid(this.account.core.fullJid), text, null, 'groupchat');
    } else {
      var contact = Lungo.Core.findByProperty(this.account.core.roster, 'jid', to);
      var caps = contact &amp;&amp; contact.presence.caps;
      var features = caps in App.caps &amp;&amp; App.caps[caps].features;
      var wantsReceipt = features &amp;&amp; Tools.toArray(features).indexOf(Strophe.NS.XEP0184);
      stanza = this.connection.Messaging.send(to, text, options.delay, wantsReceipt);
    }
    if (App.online &amp;&amp; this.connection.connected) {
      setTimeout(function () {
        this.events.onMessageDelivered($(stanza).attr('from', to));
      }.bind(this), 500);
    }
    return $(stanza).attr('id');
  }.bind(this);

  this.attentionSend = function (to) {
    this.connection.attention.request(to);
  };

  this.avatar = function (callback, jid) {
    var extract = function (vcard) {
      var url= '';
      if (vcard.find('BINVAL').length) {
        var img = vcard.find('BINVAL').text();
        var type = vcard.find('TYPE').text();
        url = 'data:' + type + ';base64,' + img;
      } else {
        url = 'img/foovatar.png';
      }
      if (callback) {
        var a = new Avatar();
        a.url = url;
        callback(a);
      }
    };
    if (jid) {
      this.connection.vcard.get(function(data) {
        var vcard = $(data).find('vCard');
        extract(vcard);
      }, jid);
    } else {
      extract($(this.vcard));
    }
  }.bind(this);

  this.avatarSet = function(blob) {
    var jid = this.account.core.fullJid;
    var avatars= App.avatars;

    Tools.picThumb(blob, 96, 96, function (url) {
      var b64 = url.split(',').pop();
      var vCardEl = $build('PHOTO');
      vCardEl.c('TYPE', {}, 'image/jpg');
      vCardEl.c('BINVAL', {}, b64);
      Store.save(url, function (index) {
        avatars[jid] = (new Avatar({chunk: index})).data;
        App.avatars= avatars;
      });
      this.connection.vcard.set(function (stanza) {
        this.account.core.avatarHash = b64_sha1(b64);
        this.account.save();
        this.presence.send();
        $('section#main[data-jid="' + jid + '"] footer span.avatar img').attr('src', url);
        $('aside#accounts article#accounts div[data-jid="' + jid + '"] span.avatar img').attr('src', url);
        if (Accounts.current === this.account) {
          $('section#me .avatar img').attr('src', url);
        }
      }.bind(this), vCardEl.tree());
    }.bind(this));
  };

  this.csnSend = function (to, state) {
    this.connection.Messaging.csnSend(to, state);
  };

  this.emojiRender = function (img, emoji) {
    App.emoji[Providers.data[this.account.core.provider].emoji].render(img, emoji);
  }.bind(this);

  this.contacts.remove = function (jid) {
    this.connection.roster.remove(jid);
    this.connection.roster.get(function(){});
  }.bind(this);

  this.muc.init = function () {
    for (let [i, chat] in Iterator(this.account.core.chats)) {
      if (chat.muc) {
        this.muc._join(chat.jid);
      }
    }
  }.bind(this);

  this.muc.explore = function (server, resolve, reject) {
    var disco = this.connection.disco;
    var process = function (s) {
      if (typeof s == 'string') {
        disco.items(s, null, process, reject);
      } else {
        s = $(s);
        var identities = s.find('identity');
        var items = s.find('item');
        if (identities.length) {
          var identity = identities.first();
          process(s.attr('from'));
        } else if (items.length) {
          items.each(function () {
            var item = $(this);
            var jid = item.attr('jid');
            if (jid.indexOf('@') > -1) {
              resolve(jid, item.attr('name'));
            } else {
              disco.info(jid, null, process, reject);
            }
          });
        } else {
          reject(s);
        }
      }
    };
    process(server);
  }.bind(this);

  this.muc.join = function (jid, title, password) {
    var account = this.account;
    var chat = Make(Chat)({
      jid: jid,
      title: title,
      muc: true,
      chunks: []
    }, account);
    Lungo.Router.section('back');
    Lungo.Router.section('back');
    account.chats.push(chat);
    account.core.chats.push(chat.core);
    chat.save(true);
    chat.show();
    this.muc._join(jid, password);
  }.bind(this);

  this.muc._join = function (jid, password) {
    Tools.log('JOINING', jid);
    var connector = this;
    var account = connector.account;
    var chat = account.chatGet(jid);
    var history = chat.core.last &amp;&amp; chat.core.last.stamp &amp;&amp; {since: Tools.stamp(Tools.unstamp(chat.core.last.stamp).getTime()/1000 + 1)};
    this.connection.muc.join(
      jid,
      Strophe.getNodeFromJid(this.account.core.fullJid),
      function (e) {
        return true;
      },
      function (e) {
        Tools.log('MUC PRES', e);
        return true;
      },
      function (e) {
        Tools.log('MUC ROSTER', e);
        account.chatGet(jid).core.participants = Object.keys(e);
        for (var [key, value] in Iterator(e)) {
          if (value.affiliation == 'owner') {
            chat.core.info.owner = Strophe.getBareJidFromJid(value.jid);
            break;
          }
        }
        if ($('section#chat').hasClass('show') &amp;&amp; $('section#chat')[0].dataset.jid == chat.core.jid) {
          chat.show();
        }
        chat.save();
        return true;
      },
      password,
      history
    );
  }.bind(this);

  this.muc.avatar = function (callback, id) {
    callback(new Avatar({url: 'https://raw.githubusercontent.com/loqui/im/dev/src/img/goovatar.png'}));
  };

  this.muc.participantsGet = function (jid) {
    // Not necessary
  };

  this.muc.expel = function (gid, jid) {
    if (jid) {

    } else {
      this.connection.muc.leave(gid, function (e) {
        Tools.log('MUC LEAVE', e);
      });
    }
  }.bind(this);

  this.muc.create = function (title, domain, members) {
    var node = title.toLowerCase().replace(/ /g, '').replace(/ñ/g, 'n');
    var jid = node + '@' + domain;
    this.muc.join(jid, title);
    this.muc.invite(jid, members, title);
  }.bind(this);

  this.muc.invite = function (gid, members, title) {
    for (let i in members) {
      let jid = members[i];
      this.connection.muc.directInvite(gid, jid, _('MucInvitationText', {title: title}));
    }
  }.bind(this);

  this.handlers.init = function () {
    this.connection.deleteHandler(this.handlers.onMessage);
    this.connection.deleteHandler(this.handlers.onAttention);
    this.connection.deleteHandler(this.handlers.onSubRequest);
    this.connection.deleteHandler(this.handlers.onTime[0]);
    this.connection.deleteHandler(this.handlers.onTime[1]);
    this.connection.deleteHandler(this.handlers.onDisco[0]);
    this.connection.deleteHandler(this.handlers.onDisco[1]);
    this.connection.deleteHandler(this.handlers.onDisco[2]);
    this.connection.deleteHandler(this.handlers.onDisco[3]);
    this.handlers.onMessage = this.connection.addHandler(this.events.onMessage, null, 'message');
    this.handlers.onSubRequest = this.connection.addHandler(this.events.onSubRequest, null, 'presence', 'subscribe');
    this.handlers.onTime = this.connection.time.handlify(this.events.onTime);
    this.handlers.onAttention = this.connection.attention.handlify(this.events.onAttention);
    this.handlers.onDisco = this.connection.disco.handlify(this.events.onDisco);
    this.handlers.onVersion = this.connection.version.handlify(this.events.onVersion);
  }.bind(this);

  this.events.onDisconnected = function (stanza) {
  }.bind(this);

  this.events.onMessage = function (stanza) {
    var account = this.account;
    var tree = $(stanza);
    var muc = tree.attr('type') == 'groupchat';
    var from = tree.attr('from');
    var to = muc ? Strophe.getBareJidFromJid(tree.attr('from')) : Strophe.getBareJidFromJid(tree.attr('to'));
    var body = tree.children('body').length ? tree.children('body').text() : null;
    var composing = tree.children('composing').length;
    var paused = tree.children('paused').length || tree.children('active').length;
    var request = tree.children('request').length;
    var received = tree.children('received').length;
    var x = tree.children('x').length;
    if (body &amp;&amp; !(muc &amp;&amp; from == to + '/' + Strophe.getNodeFromJid(account.core.fullJid))) {
      var date = new Date();
      var stamp = tree.children('delay').length
        ? Tools.localize(tree.children('delay').attr('stamp'))
        : Tools.localize(Tools.stamp());
      var msg = Make(Message)(account, {
        from: Strophe.getBareJidFromJid(from),
        to: Strophe.getBareJidFromJid(to),
        text: body,
        stamp: stamp
      }, {
        muc: muc
      });
      if (muc) {
        msg.core.pushName = Strophe.getResourceFromJid(from);
      }
      msg.receive();
    }
    if (account.supports('csn') &amp;&amp; App.settings.csn) {
      if(composing &amp;&amp; Strophe.getBareJidFromJid(from) == $('section#chat')[0].dataset.jid){
        $("section#chat #typing").show();
      }else if(paused &amp;&amp; Strophe.getBareJidFromJid(from) == $('section#chat')[0].dataset.jid){
        $("section#chat #typing").hide();
      }
    }
    if (request &amp;&amp; !(composing) &amp;&amp; !(paused)) {
      var out = $msg({to: from, from: to, id: this.connection.getUniqueId()});
      request = Strophe.xmlElement('received', {'xmlns': Strophe.NS.XEP0184, 'id': tree.attr('id')});
      out.tree().appendChild(request);
      this.connection.send(out);
    }
    if (received) {
      this.events.onMessageDelivered(stanza);
    }
    if (x) {
      x = tree.find('x');
      switch (x.attr('xmlns')) {
        case 'jabber:x:delay':
          break;
        case 'jabber:x:conference':
          this.muc.join(x.attr('jid'), x.attr('jid'), x.attr('password'));
          break;
      }
    }
    return true;
  }.bind(this);

  this.events.onMessageDelivered = function (stanza) {
    var msg = $(stanza);
    var msgId = (msg.children('received').length > 0) ? msg.children('received').attr('id') : msg.attr('id');
    var from = Strophe.getBareJidFromJid(msg.attr('from'));
    var account = this.account;
    var chat = account.chatGet(from);
    chat.core.lastAck = Tools.localize(Tools.stamp());
    chat.save();
    account.markMessage.push({from : from, msgId : msgId});
    return true;
  }.bind(this);

  this.events.onPresence = function (items, item, to) {
    var connector = this;
    var account = this.account;
    if (to) {
      var sameOrigin = Strophe.getDomainFromJid(to) == Providers.data[account.core.provider].autodomain;
      var noMulti = !account.supports('multi');
      if (to == account.core.user || (noMulti &amp;&amp; sameOrigin)) {
        connector.roster = items;
        connector.roster.sort(function (a,b) {
          var aname = a.name ? a.name : a.jid;
          var bname = b.name ? b.name : b.jid;
          return aname > bname;
        });
        var i = 0;
        var map = function (entry, cb) {
          var name, show, status, photo, caps, priority = null;
          for (var [key, resource] in Iterator(entry.resources)) {
            if (resource.priority >= priority) {
              name = key;
              show = resource.show || 'a';
              status = resource.status || _('show' + show);
              photo = resource.photo;
              caps = resource.caps;
              priority = resource.priority;
            }
          }
          if (photo &amp;&amp; entry.jid in App.avatars &amp;&amp; App.avatars[entry.jid].id != photo) {
            var avatar = new Avatar(App.avatars[entry.jid]);
            connector.avatar(function (a) {
              a.urlWritePromise.then(function (val) {
                Store.drop(avatar.chunk, function () {
                  avatar.id = photo;
                  avatar.chunk = a.chunk;
                  avatar.stamp = a.stamp;
                  App.avatars[entry.jid] = avatar.data;
                  var own = entry.jid == account.core.fullJid;
                  if (own) {

                  } else {
                    $('[data-jid="' + entry.jid + '"] span.avatar img').attr('src', val);
                  }
                });
              });
            }, entry.jid);
          }
          if (caps &amp;&amp; !(caps in App.caps)) {
            connector.connection.disco.info(connector.roster[i].jid + '/' + name, caps);
          }
          i++;
          cb(null, {
            jid: entry.jid,
            name: entry.name,
            presence: {
              name: name,
              show: show,
              status: status,
              caps: caps
            }
          });
        };
        async.map(connector.roster, map.bind(account), function (err, result) {
          account.core.roster = result;
          account.presenceRender();
        });
      }
    }
  }.bind(this);

  this.events.onSubRequest = function (stanza) {
    var bareJid = Strophe.getBareJidFromJid($(stanza).attr('from'));
    this.connection.roster.authorize(bareJid);
    this.connection.roster.subscribe(bareJid);
    return true;
  }.bind(this);

  this.events.onAttention = function (stanza) {
    var from = Strophe.getBareJidFromJid($(stanza).attr('from'));
    if (App.settings.boltGet) {
      var chat = this.account.chats[this.account.chatFind(from)];
      if (!chat) {
        var contact = Lungo.Core.findByProperty(this.account.core.roster, 'jid', from);
        chat = Make(Chat)({
          jid: from,
          title: contact ? contact.name || from : from,
          chunks: []
        }, account);
      }
      window.navigator.vibrate([100,30,100,30,100,200,200,30,200,30,200,200,100,30,100,30,100]);
      App.notify({
        subject: chat.core.title,
        text: _('SentYou', { type: _('MediaType_bolt') }),
        pic: 'https://raw.github.com/loqui/im/dev/src/img/bolt.png',
        callback: function () {
          chat.show();
          App.toForeground();
        }
      }, 'thunder', true);
    }
    Tools.log(from, 'sent you a bolt.');
    return true;
  }.bind(this);

  this.events.onDisco = function (stanza) {
    stanza = $(stanza);
    var key = stanza.find('query').attr('node');
    var caps= App.caps;
    var value = {
      identities: stanza.find('identity').map(function (i, e, a) {
        return {type: $(e).attr('type'), name: $(e).attr('name'), category: $(e).attr('category')};
      }),
      features: stanza.find('feature').map(function (i, e, a) {
        return $(e).attr('var');
      })
    };
    caps[key] = value;
    App.caps= caps;
    return true;
  }.bind(this);

  this.events.onVersion = function (stanza) {
    return true;
  }.bind(this);

};

App.logForms.XMPP = function (provider, article) {
  var data = Providers.data[provider];
  return {
    get html () {
      if (article) {
        article
          .append($('&lt;h1/>').css('color', data.color).html(_('SettingUp', { provider: data.longName })))
          .append($('&lt;img/>').attr('src', 'img/providers/' + provider + '.svg'))
          .append($('&lt;label/>').attr('for', 'user').text(_(data.terms.user, { provider: data.altname })))
          .append($('&lt;input/>').attr('type', data.terms.userInputType).attr('x-inputmode', 'verbatim').attr('name', 'user').attr('placeholder', (data.terms.placeholder || _(data.terms.user, { provider: data.altname }) )))
          .append($('&lt;label/>').attr('for', 'pass').text(_(data.terms.pass)))
          .append($('&lt;input/>').attr('type', 'password').attr('name', 'pass').attr('placeholder', '******'));
        if (data.notice) {
          article.append($('&lt;small/>').html(_(provider + 'Notice')));
        }
        var buttongroup = $('&lt;div/>').addClass('buttongroup')
          .append($('&lt;button/>').addClass('submit').css('backgroundColor', data.color).text(_('LogIn')))
          .append($('&lt;button/>').addClass('back').text(_('GoBack')));
        article.append(buttongroup);
      }
    },
    events: function (target) {
      if (target.hasClass('submit')) {
        var article = target[0].parentNode.parentNode;
        var provider = article.parentNode.id;
        var user = Providers.autoComplete($(article).children('[name="user"]').val(), provider);
        var pass = $(article).children('[name="pass"]').val();
        var cc = $(article).children('[name="cc"]').val();
        if (user &amp;&amp; pass) {
          var account = new Account({
            user: user,
            pass: pass,
            provider: provider,
            resource: App.defaults.Account.core.resource,
            enabled: true,
            chats: []
          });
          account.test();
        }
      }
    }
  };
};

App.emoji.XMPP = {

  map: [
    ['emoji1', '>:-(', '>:('],
    ['emoji2', ';)', ';-)'],
    ['emoji3', ':-!', ':!'],
    ['emoji4', ':-[', ':['],
    ['emoji5', ':-$', ':$'],
    ['emoji6', ':-\\'],
    ['emoji7', ':\'('],
    ['emoji8', ':-(', ':('],
    ['emoji9', '8-)', '8)'],
    ['emoji10', ':-D', ':D'],
    ['emoji11', '>:O'],
    ['emoji12', ':-O', ':O', '=-O'],
    ['emoji13', 'O:-)'],
    ['emoji14', ':-)', ':)'],
    ['emoji15', ':-P', ':P'],
    ['emoji16', ':-X'],
    ['emoji17', ':kiss:', ':heart:'],
    ['emoji18', ':yes:'],
    ['emoji19', ':no:']
  ],

  fy: function (text) {
    var mapped = text;
    var map = this.map;
    if (mapped &amp;&amp; map.length !== undefined) {
      for (var i in map) {
        var original = map[i][0];
        for (var j in map[i].slice(1)) {
          var token = map[i].slice(1)[j].replace(/([\*\|\(\)\[\]\\\$\{\}\.\+\?\^])/g, '\\$1');
          var rexp = new RegExp('('+token+')', 'g');
          mapped = mapped.replace(rexp, '&lt;img src="img/emoji/xmpp/'+original+'.png" alt="$1" />');
          if (mapped != text) {
            return mapped;
          }
        }
      }
    }
    return text;
  },

  render: function (img, emoji) {
    img.attr('src', 'img/emoji/xmpp/' + emoji[0] + '.png');
    img[0].dataset.emoji= emoji[1];
  }

};

App.emoji.FB = {

  map: [
    ['emoji1', '>:('],
    ['emoji2', ':poop:'],
    ['emoji3', '3:)'],
    ['emoji4', '>:O','>:o'],
    ['emoji5', 'O:)'],
    ['emoji6', ':putnam:'],
    ['emoji7', ':)', '=)'],
    ['emoji8', ':(', '=('],
    ['emoji9', ':P', ':p'],
    ['emoji10', ':D'],
    ['emoji11', ':O', ':o'],
    ['emoji12', ':3'],
    ['emoji13', '8)', '8-)'],
    ['emoji14', '8|', '8-|'],
    ['emoji15', ':\\', ':/', ':-\\', ':-/'],
    ['emoji16', ':\'('],
    ['emoji17', ':*', ':-*'],
    ['emoji18', '&lt;3'],
    ['emoji19', 'o.O'],
    ['emoji20', 'O.o'],
    ['emoji21', ':v'],
    ['emoji22', ';-)', ';)'],
    ['emoji23', '^_^'],
    ['emoji24', '-_-'],
    ['emoji25', ':|]'],
    ['emoji26', '(^^^)'],
    ['emoji27', '&lt;(")']
  ],

  fy: function (text) {
    var mapped = text;
    var map = this.map;
    if (mapped &amp;&amp; map.length !== undefined) {
      for (var i in map) {
        var original = map[i][0],
            emoji = map[i].slice(1);
        for (var j in emoji) {
          var token = emoji[j].replace(/([\*\|\(\)\[\]\\\$\{\}\.\+\?\^])/g, '\\$1');
          var rexpStart = new RegExp('^('+token+')');
          mapped = mapped.replace(rexpStart, '&lt;img src="img/emoji/fb/'+original+'.png" alt="$1" />');
          var rexp = new RegExp(' ('+token+')', 'g');
          mapped = mapped.replace(rexp, ' &lt;img src="img/emoji/fb/'+original+'.png" alt="$1" />');
        }
      }
      if (mapped != text) {
        return mapped;
      }
    }
    return text;
  },

  render: function (img, emoji) {
    img.attr('src', 'img/emoji/fb/' + emoji[0] + '.png');
    img[0].dataset.emoji=emoji[1];
  }

};

App.emoji.GTALK = {

  map: [
    ['angry', 'x-('],
    ['brokenheart', '&amp;lt;/3'],
    ['cool', 'B-)'],
    ['cowbell', '+/\'\\'],
    ['crab', 'V.v.V'],
    ['cry', ':\'('],
    ['devil', '}:-)'],
    ['frown', ':(', '=(', ':-('],
    ['grin', ':D', '=D', ':-D'],
    ['heart', '&amp;lt;3'],
    ['kissstar', ':*', ':-x'],
    ['monkey', ':(|)'],
    ['mustache', ':{'],
    ['pig', ':(:)'],
    ['poop', '~@~'],
    ['robot', ':|]'],
    ['rockout', '\\m/'],
    ['shocked', ':-o'],
    ['slant', ':-/', '=/'],
    ['smile', ':)', '=D', ':-)'],
    ['straightface', ':-\|'],
    ['tongue', ':p', ':P', '=p', '=P', ':-p', ':-P'],
    ['wince', '\\>.\\&lt;'],
    ['wink', ';)', ';-)', ';^)']
  ],

  fy: function (text) {
    var mapped = text;
    var map = this.map;
    if (mapped &amp;&amp; map.length !== undefined) {
      for (var i in map) {
        var original = map[i][0];
        for (var j in map[i].slice(1)) {
          var token = map[i].slice(1)[j].replace(/([\*\|\(\)\[\]\\\$\{\}\.\+\?\^])/g, '\\$1');
          var rexp = new RegExp('('+token+')', 'g');
          mapped = mapped.replace(rexp, '&lt;img src="img/emoji/gtalk/'+original+'.gif" alt="$1" />');
          if (mapped != text) {
            return mapped;
          }
        }
      }
    }
    return text;
  },

  render: function (img, emoji) {
    img.attr('src', 'img/emoji/gtalk/' + emoji[0] + '.gif');
    img[0].dataset.emoji= emoji[1];
  }

};
</pre>
	</article>
</section>





		</div>
	</div>

	<div class="clearfix"></div>

	

</div>
</div>


<footer>


	<span class="copyright">
	DocStrap Copyright © 2012-2014 The contributors to the JSDoc3 and DocStrap projects.
	</span>
	<br />

<span class="jsdoc-message">
	Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0-dev</a>
	on Wed Nov 25th 2015 using the <a href="https://github.com/terryweiss/docstrap">DocStrap template</a>.
</span>
<span class="jsdoc-message">
	Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0-dev</a>
	on Wed Nov 25th 2015 using the <a
	href="https://github.com/terryweiss/docstrap">DocStrap template</a>.
</span>
</footer>

<!--<script src="scripts/sunlight.js"></script>-->
<script src="scripts/docstrap.lib.js"></script>
<script src="scripts/bootstrap-dropdown.js"></script>
<script src="scripts/toc.js"></script>

<script>
$( function () {
	$( "[id*='$']" ).each( function () {
		var $this = $( this );

		$this.attr( "id", $this.attr( "id" ).replace( "$", "__" ) );
	} );

	$( "#toc" ).toc( {
		anchorName  : function ( i, heading, prefix ) {
			var id = $( heading ).attr( "id" );
			return id && id.replace(/\~/g, '-inner-').replace(/\./g, '-static-') || ( prefix + i );
		},
		selectors   : "h1,h2,h3,h4",
		showAndHide : false,
		scrollTo    : "100px"
	} );

	$( "#toc>ul" ).addClass( "nav nav-pills nav-stacked" );
	$( "#main span[id^='toc']" ).addClass( "toc-shim" );
	$( '.dropdown-toggle' ).dropdown();
	//			$( ".tutorial-section pre, .readme-section pre" ).addClass( "sunlight-highlight-javascript" ).addClass( "linenums" );

	$( ".tutorial-section pre, .readme-section pre" ).each( function () {
		var $this = $( this );

		var example = $this.find( "code" );
		exampleText = example.html();
		var lang = /{@lang (.*?)}/.exec( exampleText );
		if ( lang && lang[1] ) {
			exampleText = exampleText.replace( lang[0], "" );
			example.html( exampleText );
			lang = lang[1];
		} else {
			lang = "javascript";
		}

		if ( lang ) {

			$this
			.addClass( "sunlight-highlight-" + lang )
			.addClass( "linenums" )
			.html( example.html() );

		}
	} );

	Sunlight.highlightAll( {
		lineNumbers : true,
		showMenu : true,
		enableDoclinks : true
	} );
} );
</script>



<!--Navigation and Symbol Display-->


<!--Google Analytics-->


</body>
</html>
